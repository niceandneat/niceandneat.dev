<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap"><link rel="stylesheet" href="/css/index.326292b5b63ef68a4d6e.css"><title>(불편하게) 블로그 만들기</title><meta name="description" content="웹의 뿌리를 느끼기 위해 HTML 파일 생성부터 배포까지 일부러 불편하게 만들었던 블로그 이야기입니다."><meta property="og:title" content="(불편하게) 블로그 만들기"><meta property="og:url" content="https://niceandneat.dev/posts/blog"><meta property="og:description" content="웹의 뿌리를 느끼기 위해 HTML 파일 생성부터 배포까지 일부러 불편하게 만들었던 블로그 이야기입니다."><meta property="og:type" content="website"><meta property="og:image" content="https://niceandneat.dev/images/main.png"><meta property="og:image:alt" content="(불편하게) 블로그 만들기"><link rel="stylesheet" href="/css/prism-dark.e4c24f302c13c82e19b1.css"><link rel="icon" href="/favicon.ico"></head><body><header class="header"><div class="header__title"><a class="header__title-link" href="/">nice and neat</a></div><a href="/about"><div class="flex-circle__container"><div class="flex-circle__item">About</div></div></a></header><main class="main"><div class="markdown-front"><h1 class="markdown-front__title">(불편하게) 블로그 만들기</h1><div class="markdown-front__date">2021-01-18</div></div><div class="markdown"><blockquote><p>이 글은 독자가 Webpack, Docker등 여기서 다루는 기술에 어느정도 익숙하다 가정하고 작성되었습니다.</p></blockquote><blockquote><p>제가 글솜씨가 부족하기도 하고 생각보다 다룰 내용이 많아 코드와 내용을 많이 생략했습니다. 중간중간 걸어둔 링크와 <a href="https://github.com/niceandneat/niceandneat.dev">Github</a>을 참조해주세요!</p></blockquote><h2>선택 <a name="선택" class="anchor" href="#선택"><span class="header-link"></span></a></h2><p>힘들었던 한 학기가 끝나고 모처럼 여유로운 방학이 생겼다. 미루고 미뤘던 블로그를 만들어 보고싶어졌다.</p><p>블로그를 만드는 방법은 정말 다양하다. Node.js로 <strong>Server Side Rendering</strong> 서버 (<a href="https://nextjs.org/">Next.js</a>, <a href="https://expressjs.com/en/resources/template-engines.html">Express + Template Engine</a>)를 만들어 <strong>PaaS</strong> (<a href="https://www.netlify.com/">Netlify</a>, <a href="https://www.heroku.com/">Heroku</a>, <a href="https://firebase.google.com/">Firebase</a>)에 올려두면 된다. 아니면 <strong>Static Site Generator</strong> (<a href="https://www.gatsbyjs.com/">Gatsby</a>, <a href="https://gohugo.io/">Hugo</a>, <a href="https://jekyllrb.com/">Jekyll</a>)를 이용해 static file들을 만든 뒤 <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">AWS S3</a>, <a href="https://pages.github.com/">Github Pages</a> 등을 이용해 간단히 호스팅해도 된다. 사실 이런거 저런거 만들 필요없이 이미 잘 만들어진 <a href="https://section.blog.naver.com/">네이버 블로그</a>, <a href="https://www.tistory.com/">티스토리</a>, <a href="https://medium.com/">Medium</a> 등을 이용해도 된다.</p><p>이렇게 많은 선택지를 보다보니 오히려 좀 더 다르게 만들어보고 싶다는 생각이 들었다. 회사에서는 React를 주로 사용해서 HTML, CSS를 직접 다룰일이 거의 없었다. 게다가 CRA나 Next.js를 사용하면 번들링을 신경쓸 일도 별로 없다. 그렇다보니 HTML, CSS, Javascript 3인방에게 너무 소홀해진 감이 있다. 이번 기회에 웹페이지 만드는 과정을 최대한 온전히 느끼면서 <strong>불편하게</strong> 블로그를 만들면, 이것이 다시 웹의 근본을 찾을 수 있는 기회가 되지 않을까.</p><p>하지만 이 생각만이 불편하게 만드는 이유의 전부는 아니었다. 블로그 만들기에 앞서서 스스로 여러가지 요구사항이 있었다.</p><ol><li><p>블로그이긴 하지만 글을 많이 쓸 것 같지는 않다. 글보다는 앞으로 만들 작은 프로젝트들의 링크를 모아두는 게 주요목적이다. 개별 프로젝트 레포지토리들이 블로그의 도메인을 사용해 배포되면 좋겠다.</p></li><li><p>그래도 글을 쓸 수는 있어야한다. HTML이 아닌 별도의 문서 파일을 이용해 포스트들을 관리하지만 포스트 내부에서 스크립트도 실행할 수 있어야한다. 스크립트는 해당 문서 파일 내부가 아닌 별도의 코드 파일로 관리하고 싶다.</p></li><li><p>간단한 자기소개 페이지가 있으면 좋겠다. 또 앞으로 여러 페이지가 추가될 수 있으므로 쉽게 원하는 route를 생성할 수 있어야 한다.</p></li></ol><p>힙스터 감성과 위 요구사항을 동시에 만족시키기 위해 어떤 시행착오를 겪었는지 적어보려고 한다.</p><h2>Bundling : Webpack <a name="bundling-webpack" class="anchor" href="#bundling-webpack"><span class="header-link"></span></a></h2><p>모든 과정중에서 가장 많은 시간을 들였던 부분이다. 번들링 작업 없이 블로그의 각 페이지에 들어갈 HTML와 Asset들을 손으로 구성해서 넣어도 된다. 하지만 중복되는 코드 재사용, 외부 라이브러리 사용, Minify 나 Autoprefix 등의 post process, Typescript 빌드 등 일일이 하기엔 손이 많이 가는 작업들을 줄이기 위해서 자동화된 번들링 시스템이 필요했다. <a href="https://webpack.js.org/">Webpack</a>을 이용해 블로그의 번들링 시스템을 만들었다.</p><h3>HTML <a name="html" class="anchor" href="#html"><span class="header-link"></span></a></h3><p>이 블로그에서 HTML을 만드는 방법은 두가지가 있다. <code class="language-">.html</code> 파일에서 만드는 방법과 <code class="language-">.md</code> 파일에서 만드는 방법이다. <code class="language-">.md</code> 파일은 포스트 문서를 위해 사용하고 나머지 페이지는 <code class="language-">.html</code> 파일로부터 만들어 진다. 먼저 <code class="language-">.html</code> 파일에서 만드는 방법을 살펴보고자 한다. 여기에도 여러가지 선택지가 있었다.</p><h4>HTML 첫번째 시도 : Template Engine <a name="html-첫번째-시도-template-engine" class="anchor" href="#html-첫번째-시도-template-engine"><span class="header-link"></span></a></h4><p>먼저 <a href="https://github.com/mde/ejs">EJS</a>나 <a href="https://github.com/handlebars-lang/handlebars.js">Handlebars</a> 같은 template engine을 사용해보려고 했다. 각각 webpack loader도 제공해서 <a href="https://github.com/jantimon/html-webpack-plugin">HTML Webpack Plugin</a>의 <code class="language-">template</code> option을 작성한 파일로 설정하면 어렵지 않게 HTML을 생성할 수 있었다. 특히 Handlebars같은 경우 Prtials, Helpers같은 다양한 편의 기능을 제공해 코드 재사용이 쉬웠다.</p><p>하지만 문제점들도 있었다.</p><ol><li><p>추가된 문법이 기존 HTML과 많이 다르다.</p></li><li><p>VSCode에서 Extension Support가 좋지 못하다.</p></li><li><p>머리속에 훨씬 좋은 대안이 자꾸 떠오른다... JSX!</p></li></ol><h4>HTML 두번째 시도 : React <a name="html-두번째-시도-react" class="anchor" href="#html-두번째-시도-react"><span class="header-link"></span></a></h4><p><a href="https://dev.to/jantimon/html-webpack-plugin-4-has-been-released-125d">이 포스트</a>에서 template engine으로 React를 사용하는 것을 보고 당장 시도해봤다. <code class="language-">ReactDOMServer.renderToString()</code>을 이용해 React component를 HTML string으로 바꿔서 사용한다. 묘하게 어색한 template engine들을 쓰다가 component들로 착착 분리해서 만드니까 행복했다.</p><p>하지만 여기에도 문제점이 있었다. 아래 코드를 보자.</p><div class="blog-highlight"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'./awesomeStyle.css'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">AwesomeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>awesome-class<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">AWESOME!!!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>만약 이 코드가 Client Side Rendering을 하는 component였다면 전혀 이상할 것이 없다. <code class="language-">MiniCssExtractPlugin</code>이 마법같이 <code class="language-">./awesomeStyle.css</code>를 찾아 output 폴더에 넣어줄 것이다. 하지만 위의 코드는 빌드과정에서 HTML string을 만들기 위해 실행된다. 즉 이 코드는 <code class="language-">entry</code> 파일이 아니라 <code class="language-">HTMLWebpackPlugin</code>의 <code class="language-">template</code>으로 사용된다. <code class="language-">HTMLWebpackPlugin</code>으로 위 파일을 컴파일 하면 다음과 같은 에러가 발생한다.</p><div class="blog-highlight"><pre class="language-"><code class="language-">CodeGenerationError: No template for dependency: CssDependency</code></pre></div><p><code class="language-">template</code> 실행과정에서 만난 <code class="language-">.css</code> 파일을 처리할 때 어떤 이유인지 <code class="language-">HTMLWebpackPlugin</code>과 <code class="language-">MiniCssExtractPlugin</code>이 충돌을 일으킨다. 아마 <code class="language-">MiniCssExtractPlugin</code>을 사용하면 JS 파일이 아닌 곳에서 CSS 파일을 <code class="language-">import</code>할 경우 webpack이 어떻게 처리할 지 모르는 것 같지만 정확한 건 코드를 까봐야 알 것 같다. CSS파일들을 component별로 import하지 않고 따로 작성하고 파일의 경로를 HTML string에 직접 <code class="language-">&lt;link&gt;</code> 태그로 넣어두면, <code class="language-">file-loader</code>나 Webpack 5의 <code class="language-">type: &#39;asset/resource&#39;</code> 옵션을 통해 빌드할 수 있다.</p><blockquote><p>뒤에서 설명하겠지만 SCSS를 사용하게 되면서 위와 같이 스타일 파일들을 문서와 따로 관리하는 방식을 채택했다.</p></blockquote><p>하지만 component의 코드와 스타일이 따로 관리되는 것은 React 스럽지 않다고 판단해 이 방법은 보류하기로 했다. 이후에 loader나 plugin을 더 깊게 이해한 뒤에 건드려볼 수 있을 것 같다.</p><h4>HTML 세번째 시도 : HTML? <a name="html-세번째-시도-html-" class="anchor" href="#html-세번째-시도-html-"><span class="header-link"></span></a></h4><p>처음에 <code class="language-">.html</code> 파일에서 HTML을 만든다는게 무슨말인가 의아할 수도 있었을 것이다. 어차피 마음에 드는 template engine도 없으니 그냥 HTML을 직접 작성하는 편이 좋다고 생각했다. 그래서 HTML Webpack Plugin의 <code class="language-">template</code> 옵션을 직접 작성한 <code class="language-">.html</code> 파일로 지정했다.</p><p>두번째 <code class="language-">.html</code>을 작성하려고 할 때 바로 문제가 발생했다. 같은 내용의 <code class="language-">&lt;head&gt;</code> 태그를 넣기가 너무 귀찮았다. <code class="language-">html-loader</code>의 <a href="https://github.com/webpack-contrib/html-loader#posthtml">공식문서</a>에서 <a href="https://github.com/posthtml/posthtml">PostHTML</a>을 사용하는 것을 보고 시도해봤다. Plugin은 HTML 태그 재사용을 위한 <a href="https://github.com/posthtml/posthtml-include">Include Plugin</a>만 사용했다. 기존 HTML의 문법을 해치지 않는 선에서 HTML 코드를 재사용할 수 있었다. 앞서 Template Engine의 단점이었던 부분을 보완해 꽤 괜찮다고 느껴 이 방법을 채택하기로 했다. 이렇게 결국 <code class="language-">.html</code> 파일에서 HTML을 만들게 되었다.</p><h3>Markdown <a name="markdown" class="anchor" href="#markdown"><span class="header-link"></span></a></h3><p>블로그 포스트 내용을 기록하기 위해 Markdown(<code class="language-">.md</code>)파일을 사용했다. Gatsby를 사용할 때 Markdown 파일을 HTML 파일로 바꿔주는 <a href="https://www.gatsbyjs.com/plugins/gatsby-transformer-remark/?=mark">Plugin</a>이 정말 좋았었는데 비슷한 것을 구현해보고 싶었다. 최소한 다음과 같은 기능이 있었으면 했다.</p><ol><li><p>Markdown 파일을 HTML 파일로 변환한다.</p></li><li><p>이때 각 markdown 토큰 별로 생성되는 HTML 태그를 설정 가능하다.</p></li><li><p>포스트 내부의 코드를 스타일링 한다.</p></li><li><p><a href="https://jekyllrb.com/docs/front-matter/">frontmatter</a>를 사용한다.</p></li><li><p>이미 존재하는 template을 사용할 수 있다. (같은 내용의 <code class="language-">&lt;head&gt;</code> 태그를 넣기가 귀찮다.)</p></li></ol><p>1번 기능을 제공하는 <a href="https://github.com/peerigon/markdown-loader">markdown-loader</a>가 이미 존재했다. 하지만 나머지 기능들을 위해 새로 markdown loader를 만들기로 했다.</p><p><strong>config/loaders/markdown.ts</strong></p><div class="blog-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> marked <span class="token keyword">from</span> <span class="token string">'marked'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fm <span class="token keyword">from</span> <span class="token string">'front-matter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Prism <span class="token keyword">from</span> <span class="token string">'prismjs'</span><span class="token punctuation">;</span>

<span class="token comment">// ...생략</span>

marked<span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span>defaultOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
marked<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>extendOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">MarkdownLoaderOptions</span> <span class="token keyword">extends</span> <span class="token class-name">marked</span><span class="token punctuation">.</span>MarkedOptions <span class="token punctuation">{</span>
  templatePath<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">markdownLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> source<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    templatePath<span class="token punctuation">,</span>
    <span class="token operator">...</span>markedOptions
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> MarkdownLoaderOptions<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> frontMatter <span class="token operator">=</span> <span class="token generic-function"><span class="token function">fm</span><span class="token generic class-name"><span class="token operator">&lt;</span>Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">>></span></span></span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> markdown <span class="token operator">=</span> <span class="token function">marked</span><span class="token punctuation">(</span>frontMatter<span class="token punctuation">.</span>body<span class="token punctuation">,</span> markedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> attributes <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>frontMatter<span class="token punctuation">.</span>attributes<span class="token punctuation">,</span> markdown <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> template <span class="token operator">=</span> templatePath <span class="token operator">&amp;&amp;</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">replaceAttrs</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>Loader 코드의 일부를 가져왔다. 현재 Webpack 5에서 loader의 <code class="language-">this</code> type을 제공해주지 않아 <code class="language-">any</code>로 설정해 두었다.</p><p>맨위의 <code class="language-">marked.setOptions(defaultOptions)</code>와 <code class="language-">marked.use(extendOptions)</code>는 <a href="https://prismjs.com/">Prismjs</a>를 이용한 코드 하이라이팅 로직과 code, codespan, heading 토큰에 대한 HTML 태그 렌더링 로직을 marked에 설정하는 부분이다. 렌더러를 작성할 때 <a href="https://github.com/markedjs/marked/blob/master/src/Renderer.js">소스코드</a>를 참고했다.</p><p><code class="language-">MarkdownLoaderOptions</code>은 webpack에서 loader를 사용할 때 받는 옵션의 타입이다. marked의 <code class="language-">MarkedOptions</code>을 그대로 extend하고 최종적으로 만들어진 HTML이 들어갈 template의 경로인 <code class="language-">templatePath</code>를 추가했다.</p><p>Loader 함수 내부에서는 우선 <a href="https://github.com/jxson/front-matter">front-matter</a>를 사용해 markdown <code class="language-">source</code>에서 <code class="language-">attributes</code>와 <code class="language-">body</code>를 분리한다. <code class="language-">body</code> 부분 만을 <a href="https://github.com/markedjs/marked">marked</a>를 이용해 HTML string으로 변환했다. 이때 loader 옵션에서 <code class="language-">templatePath</code>를 제외한 필드들을 marked의 옵션으로 사용한다. <code class="language-">replaceAttrs()</code>에서는 frontmatter의 <code class="language-">attributes</code>의 값들과 markdown 변환 결과를 template 파일의 해당하는 부분에 넣어준다.</p><p><strong>src/templates/markdown.html</strong></p><div class="blog-highlight"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ko<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>templates/meta.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      { "title": "{{ title }}", "description": "{{ description }}" }
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>templates/header.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>markdown-front<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>markdown-front__title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>markdown-front__date<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ date }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>markdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ markdown }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>templates/footer.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div><p>위에서 <code class="language-">{{ key }}</code> 이렇게 중괄호 두개로 묶인 부분을 <code class="language-">attributes</code>의 각 <code class="language-">key</code>에 해당하는 <code class="language-">value</code>로 변경해준다. 즉 frontmatter와 markdown의 HTML 변환 결과를 가지고 새로운 HTML string을 만들게 된다. 이렇게 생성된 string은 <code class="language-">html-lodaer</code>로 흘러들어가 다른 HTML 파일들과 같은 과정을 거치게 된다.</p><h3>SCSS <a name="scss" class="anchor" href="#scss"><span class="header-link"></span></a></h3><p>CSS대신에 <a href="https://sass-lang.com/">SCSS(SASS)</a>를 사용했다. SCSS의 variable, mixin, nesting 등의 기능이 매력적으로 다가왔고 이번 기회에 써보자는 생각이 들었다. 이미 <a href="https://github.com/webpack-contrib/sass-loader">sass-loader</a>도 존재했으므로 사용 자체는 쉬웠다. 문제는 생성된 CSS 파일을 HTML에 연결하는 방법이다. 여기에도 여러가지 방법이 존재한다.</p><ol><li><p><a href="https://github.com/webpack-contrib/style-loader">style-loader</a></p><p>CSS를 DOM을 통해 <code class="language-">&lt;style&gt;</code> 태그로 넣어준다.</p></li><li><p><a href="https://webpack.js.org/guides/asset-modules/">asset/resource</a></p><p>CSS를 내용 그대로 파일로 만들어 준다.</p></li><li><p><a href="https://github.com/webpack-contrib/mini-css-extract-plugin">MiniCssExtractPlugin</a></p><p>JS 파일마다 import 한 CSS들을 묶어서 파일로 만들어주고 <code class="language-">HTMLWebpackPlugin</code> 함께 사용하면 HTML 파일에 넣어주기까지 한다.</p></li></ol><p>분명 더 많지만 대표적으로 위 세가지가 존재한다. 처음에는 당연히 있어보이는 <code class="language-">MiniCssExtractPlugin</code>으로 HTML에 CSS를 넣었다. 하지만 이러면 스크립트가 필요하지 않은 페이지도 <code class="language-">index.ts</code>를 만들어서 SCSS 파일을 import 해줘야만 했다. 이게 싫어서 HTML 파일에 직접 <code class="language-">&lt;link&gt;</code> 태그를 만들어서 넣으면 <a href="#html-%EB%91%90%EB%B2%88%EC%A7%B8-%EC%8B%9C%EB%8F%84-react">HTML React</a>에서와 같은 에러가 발생한다.</p><p>Sass Guideline의 <a href="https://sass-guidelin.es/#architecture">Architecture</a> 항목을 보고 스타일(SCSS)파일을 문서와 따로 관리하는 방법도 좋아보였다. React로 개발하면서 항상 스타일과 마크업이 같이 묶여서 다녀야 한다는 고정관념이 있었다. 하지만 지금 이 블로그 같이 비슷한 디자인이 항상 나타나고(예: Header, Footer) 페이지 수도 적을 때에는 스타일을 따로 관리해 빌드할 때 하나의 파일로 합치는 것도 괜찮다고 생각했다.</p><p><strong>src/styles/index.scss</strong></p><div class="blog-highlight"><pre class="language-scss"><code class="language-scss"><span class="token keyword">@import</span> <span class="token string">'./reset'</span><span class="token punctuation">;</span>
<span class="token keyword">@import</span> <span class="token string">'./common'</span><span class="token punctuation">;</span>
<span class="token keyword">@import</span> <span class="token string">'./colors'</span><span class="token punctuation">;</span>
<span class="token keyword">@import</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">@import</span> <span class="token string">'./components/header.scss'</span><span class="token punctuation">;</span>
<span class="token keyword">@import</span> <span class="token string">'./components/footer.scss'</span><span class="token punctuation">;</span>
<span class="token keyword">@import</span> <span class="token string">'./components/markdown.scss'</span><span class="token punctuation">;</span>

<span class="token keyword">@import</span> <span class="token string">'./pages/main.scss'</span><span class="token punctuation">;</span>
<span class="token keyword">@import</span> <span class="token string">'./pages/about.scss'</span><span class="token punctuation">;</span></code></pre></div><p><strong>src/templates/meta.html</strong></p><div class="blog-highlight"><pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- 생략 --></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/styles/index.scss<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre></div><p>따라서 위와 같이 모든 SCSS파일을 불러오는 하나의 root 파일(<code class="language-">index.scss</code>)을 만들어 두고 이 파일을 HTML 파일에서 <code class="language-">&lt;link&gt;</code> 태그로 포함시켰다.</p><p><strong>config/webpack.common.ts</strong></p><div class="blog-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// 설명을 위해 간략화한 코드이다.</span>

<span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.s[ac]ss$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
  <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'asset/resource'</span><span class="token punctuation">,</span>
  generator<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'[name].[contenthash].css'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  use<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
    <span class="token string">'sass-loader'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div><p>Loader는 위처럼 <code class="language-">sass-loader</code>와 Autoprefix를 위한 <code class="language-">postcss-loader</code>만 사용했다. <code class="language-">type: &#39;asset/resource&#39;</code> 옵션이 loader 실행 결과로 나온 string을 파일로 저장해준다. 이제 SCSS 파일의 경로를 HTML 파일에 직접 <code class="language-">&lt;link&gt;</code> 태그를 만들어서 넣으면 빌드 결과 만들어진 파일의 경로로 바뀌어 잘 동작한다.</p><h3>Routing <a name="routing" class="anchor" href="#routing"><span class="header-link"></span></a></h3><p>Next.js의 <a href="https://nextjs.org/docs/routing/introduction">pages</a>와 같이 폴더구조가 그대로 Routing에 반영되는 기능을 만들고 싶었다. Webpack의 <code class="language-">entry</code> 옵션과 <a href="https://github.com/jantimon/html-webpack-plugin">HtmlWebpackPlugin</a> 들을 지정된 <code class="language-">pages</code> 폴더에 존재하는 디렉토리와 파일에 따라 적절하게 만들어 주는 유틸함수를 만들어 보았다.</p><p><strong>config/utils/loadPages.ts</strong></p><div class="blog-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>

<span class="token comment">// ...생략</span>

<span class="token keyword">const</span> sourceDir <span class="token operator">=</span> <span class="token string">'src'</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">LoopDirsCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span>parent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> child<span class="token operator">:</span> fs<span class="token punctuation">.</span>Dirent<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">makeLoopDirs</span><span class="token punctuation">(</span>func<span class="token operator">:</span> LoopDirsCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">loopDirs</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">{</span> withFileTypes<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">!==</span> sourceDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">loopDirs</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> loopDirs<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>여기서 먼저 볼 함수는 위의 <code class="language-">makeLoopDirs()</code>이다. 특정 parent path에서 시작해 해당 디렉토리에 있는 모든 파일과 디렉토리를 재귀적으로 돌며 인자로 받은 함수를 실행시킨다.</p><p><strong>config/utils/loadPages.ts</strong></p><div class="blog-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> indexPage <span class="token operator">=</span> <span class="token string">'main'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pageRoot <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'./src/pages'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> entry<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> html<span class="token operator">:</span> HTMLWebpackPluginOptions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> htmlDist <span class="token operator">=</span> devMode <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token string">'html/'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getEntryKey</span><span class="token punctuation">(</span>root<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> target<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">findEntry</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> child<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^index\.tsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> entryKey <span class="token operator">=</span> <span class="token function">getEntryKey</span><span class="token punctuation">(</span>pageRoot<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> entryValue <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  entry<span class="token punctuation">[</span>entryKey<span class="token punctuation">]</span> <span class="token operator">=</span> entryValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">findHTML</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> child<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> htmlFileName <span class="token operator">=</span>
    path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token operator">===</span> indexPage
      <span class="token operator">?</span> <span class="token string">'index.html'</span>
      <span class="token operator">:</span> path
          <span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>pageRoot<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.+[/\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> htmlOptions<span class="token operator">:</span> HTMLWebpackPluginOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>htmlDist<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>htmlFileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    chunks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">getEntryKey</span><span class="token punctuation">(</span>pageRoot<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    favicon<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'src/assets/images/favicon.ico'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    minify<span class="token operator">:</span> <span class="token punctuation">{</span> collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  html<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>htmlOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">findEntryAndHTML</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> child<span class="token operator">:</span> fs<span class="token punctuation">.</span>Dirent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">findEntry</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">findHTML</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">makeLoopDirs</span><span class="token punctuation">(</span>findEntryAndHTML<span class="token punctuation">)</span><span class="token punctuation">(</span>pageRoot<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>마지막 줄 처럼 위의 <code class="language-">findEntryAndHTML()</code>을 <code class="language-">makeLoopDirs()</code>에 넣어서 나온 함수에 <code class="language-">pageRoot</code>을 넣고 실행시키면 폴더/파일 구조에 따라 webpack <code class="language-">entry</code>옵션과 <code class="language-">HTMLWebpackPlugin</code> constructor에 넣을 인자들이 생긴다. 이를 webpack configuration에 사용하면 다음과 같이 HTML파일과 JS파일 들이 빌드되어 나온다.</p><p><strong>from</strong></p><div class="blog-highlight"><pre class="language-"><code class="language-">src
  |- /pages
    |- /main
      |- index.html
    |- /a
      |- index.html
      |- index.ts
      |- /b
        |- index.html
        |- index.ts</code></pre></div><p><strong>to</strong></p><div class="blog-highlight"><pre class="language-"><code class="language-">dist
  |- /html
    |- index.html
    |- /a
      |- index.html
      |- /b
        |- index.html
  |- /js
    |- a.js
    |- a.b.js</code></pre></div><p><code class="language-">HTMLWebpackPlugin</code>의 <code class="language-">chunks</code> 옵션 덕분에 <code class="language-">src</code>에서 <code class="language-">index.html</code>과 같은 폴더에 있던 <code class="language-">index.ts</code>는 빌드 후에 생긴 <code class="language-">index.html</code>에 <code class="language-">&lt;script&gt;</code> 태그로 들어간다.</p><p>포스트들의 Routing과 스트립트 파일 관리도 위와 비슷한 방법으로 해결했다.</p><h2>Server : Nginx <a name="server-nginx" class="anchor" href="#server-nginx"><span class="header-link"></span></a></h2><p>static 파일들을 만들었으니 이제 호스팅해줄 서버만 있으면 된다. 앞서 말한것 처럼 <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">AWS S3</a>, <a href="https://pages.github.com/">Github Pages</a> 등을 사용하면 편하겠지만 이 이상의 욕심이 있었다. 나중에 프로젝트를 위한 API 서버를 만들 필요가 있을지도 모르니 Reverse Proxy 서버가 하나 있으면 좋겠다는 생각이 들었다. 그래서 평소에 사용해보고 싶었던 <a href="https://nginx.org/">Nginx</a>로 웹서버를 구성하기로 했다.</p><h3>Nginx Configuration <a name="nginx-configuration" class="anchor" href="#nginx-configuration"><span class="header-link"></span></a></h3><p><a href="https://github.com/trimstray/nginx-admins-handbook">nginx-admins-handbook</a> 와 같이 nginx에 대한 좋은 자료는 많았다. 하지만 너무 많은게 문제였고 내가 이걸 다 보더라도 Server Admin이 아닌 이상 다 까먹을 것 같았다. 한번 적은 코드도 잘 안보는데 Nginx 설정파일은 얼마나 볼까. 그래서 <a href="https://github.com/digitalocean/nginxconfig.io">nginxconfig.io</a>를 사용하기로 했다. 원하는 기능만 골라주면 자동으로 적절한 Configuration 파일들을 만들어 주는 착한 서비스이다. 여기서 생성한 파일에서 살짝만 수정해 사용하기로 했다.</p><p><strong>niceandneat.dev.conf</strong></p><div class="blog-highlight"><pre class="language-"><code class="language-">server {
    # ...생략

    # index.html fallback
    location / {
        try_files $uri $uri/ $uri/index.html /html$uri /html$uri/ /html$uri/index.html =404;
    }
}</code></pre></div><p>빌드과정에서 HTML 파일들을 <code class="language-">html/</code> 폴더로 분리해 놨기때문에 이를 고려해 index.html fallback location block을 수정했다. 앞으로 만들 개별 프로젝트들은 <code class="language-">/projects</code> 폴더 안에서 별도의 파일 구조를 가질 예정이므로 <code class="language-">html/</code> 내부가 아닌 곳에 존재하는 파일도 체크하게끔 했다.</p><p><strong>niceandneat.dev.conf</strong></p><div class="blog-highlight"><pre class="language-"><code class="language-"># api reverse proxy 예시

upstream docker-api {
    server api:3000;
}

server {
    server_name             api.niceandneat.dev;

    # ...생략

    location / {
        proxy_pass http://docker-api:3000;
        include    nginxconfig.io/proxy.conf;
        # return 404;
    }
}</code></pre></div><p><code class="language-">api.niceandneat.dev</code> 서브 도메인으로 api reverse proxy 설정을 했다. 위 내용은 예시이며 <code class="language-">upstream</code> block의 내용은 이후 프로젝트 배포상태에 따라 변경될 수 있다. 현재는 돌아가야 할 API가 없어서 <code class="language-">return 404;</code> 로만 처리했다.</p><h3>Docker Compose <a name="docker-compose" class="anchor" href="#docker-compose"><span class="header-link"></span></a></h3><p>앞으로 API 서버들이 늘어날 수 있고 서비스들과의 원활한 소통과 쉬운 <del>리셋 버튼</del> 배포를 위해 <a href="https://www.docker.com/">Docker</a>를 사용하기로 했다. 하지만 내 블로그 정도를 호스팅하기엔 볼륨 바인딩정도면 충분하다고 판단해 별도의 Dockerfile 없이 <a href="https://docs.docker.com/compose/">docker-compose</a>로만 처리했다.</p><p><a href="https://letsencrypt.org/">Let&#39;s Encrypt</a> 인증서 발급을 위해 <a href="https://certbot.eff.org/">certbot</a>을 사용했다. Nginx와 certbot 서비스를 돌리는 <code class="language-">docker-compose</code> 파일은 다음과 같다.</p><p><strong>docker-compose.yaml</strong></p><div class="blog-highlight"><pre class="language-"><code class="language-">version: '3.9'
services:
  nginx:
    image: nginx:latest
    restart: always
    volumes:
      - ./dist:/var/www/niceandneat.dev
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/sites-available:/etc/nginx/sites-available
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled
      - ./nginx/nginxconfig.io:/etc/nginx/nginxconfig.io
      - ./certbot/keys:/etc/nginx/keys
      - ./certbot/letsencrypt:/etc/letsencrypt
      - ./certbot/www:/var/www/_letsencrypt
    ports:
      - 80:80
      - 443:443
    entrypoint: '/bin/sh -c ''while :; do sleep 6h & wait ${!}; nginx -s reload; done & nginx -g "daemon off;"'''
  certbot:
    image: certbot/certbot
    restart: always
    volumes:
      - ./certbot/keys:/etc/keys
      - ./certbot/letsencrypt:/etc/letsencrypt
      - ./certbot/www:/var/www/_letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait ${!}; done;'"</code></pre></div><p>볼륨 바인딩 부분이 꽤 많은데 깔끔하게 하는 방법을 찾지 못했다. Certbot의 <code class="language-">entrypoint</code>는 유효기간이 90일인 Let&#39;s Encrypt의 인증서를 12시간마다 갱신해주는 스크립트이다. Nginx의 <code class="language-">entrypoint</code>는 갱신된 인증서를 반영하기위해 6시간마다 configuration을 reload해주는 스크립트이다.</p><p>이 docker-compose 파일을 이용해 실제로 Diffie-Hellman key를 발급받고 Let&#39;s Encrypt 인증서를 받는 스크립트를 작성했다. 스크립트는 <a href="https://github.com/digitalocean/nginxconfig.io">nginxconfig.io</a>와 <a href="https://github.com/wmnnd/nginx-certbot">https://github.com/wmnnd/nginx-certbot</a>를 참조했다.</p><div class="blog-highlight"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">set</span> -e
<span class="token assign-left variable">domains</span><span class="token operator">=</span><span class="token punctuation">(</span>niceandneat.dev api.niceandneat.dev<span class="token punctuation">)</span>
<span class="token assign-left variable">certificates_path</span><span class="token operator">=</span><span class="token string">"./certbot"</span>
<span class="token assign-left variable">email</span><span class="token operator">=</span><span class="token string">"niceaneat@gmail.com"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -e <span class="token string">"<span class="token variable">$certificates_path</span>/keys/dhparam.pem"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"# Generate Diffie-Hellman keys..."</span>
  docker-compose run --rm --entrypoint <span class="token string">"\
    openssl dhparam \
      -out '/etc/keys/dhparam.pem' 2048"</span> certbot
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"# Found Diffie-Hellman keys on <span class="token entity" title="\&quot;">\"</span><span class="token variable">$certificates_path</span><span class="token entity" title="\&quot;">\"</span>! Using the existing one..."</span>
<span class="token keyword">fi</span>
<span class="token builtin class-name">echo</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$certificates_path</span>/letsencrypt/csr"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"# Start to Get certificates with certbot..."</span>

  <span class="token builtin class-name">echo</span> <span class="token string">"## Comment out SSL related directives in the nginx configuration"</span>
  <span class="token function">sed</span> -i -r <span class="token string">'s/(listen .*443)/<span class="token entity" title="\1">\1</span>;#/g; s/(ssl_(certificate|certificate_key|trusted_certificate) )/#;#<span class="token entity" title="\1">\1</span>/g'</span> nginx/sites-enabled/niceandneat.dev.conf

  <span class="token builtin class-name">echo</span> <span class="token string">"## Start nginx server without https settings"</span>
  docker-compose up -d nginx

  <span class="token comment">#Join $domains to -d args</span>
  <span class="token assign-left variable">domain_args</span><span class="token operator">=</span><span class="token string">""</span>
  <span class="token keyword">for</span> <span class="token for-or-select variable">domain</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">${domains<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token assign-left variable">domain_args</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$domain_args</span> -d <span class="token variable">$domain</span>"</span>
  <span class="token keyword">done</span>

  <span class="token builtin class-name">echo</span> <span class="token string">"## Obtain SSL certificates from Let's Encrypt using Certbot"</span>
  docker-compose run --rm --entrypoint <span class="token string">"\
    certbot certonly --webroot \
      <span class="token variable">$domain_args</span> \
      --email <span class="token variable">$email</span> \
      -w /var/www/_letsencrypt \
      -n \
      --agree-tos \
      --force-renewal"</span> certbot

  <span class="token builtin class-name">echo</span> <span class="token string">"## Stop and remove nginx (without https) container"</span>
  docker-compose down

  <span class="token builtin class-name">echo</span> <span class="token string">"## Uncomment SSL related directives in the configuration"</span>
  <span class="token function">sed</span> -i -r <span class="token string">'s/#?;#//g'</span> /etc/nginx/sites-enabled/niceandneat.dev.conf
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"# Found certificates on <span class="token entity" title="\&quot;">\"</span><span class="token variable">$certificates_path</span><span class="token entity" title="\&quot;">\"</span>! Using the existing one..."</span>
<span class="token keyword">fi</span>
<span class="token builtin class-name">echo</span>

<span class="token builtin class-name">echo</span> <span class="token string">"# Finished settings! Run 'docker-compose up -d"</span>
<span class="token builtin class-name">echo</span></code></pre></div><p>위 스크립트를 실행하고 <code class="language-">docker-compose up -d</code>를 입력하면 서버가 실행된다!</p><h3>AWS Lightsail <a name="aws-lightsail" class="anchor" href="#aws-lightsail"><span class="header-link"></span></a></h3><p>Docker를 돌릴 서버는 <a href="https://lightsail.aws.amazon.com/">AWS Lightsail</a>로 선택했다. 이유는 사용하기 쉽고 저렴해서이다. 가격으로만 보자면 비슷한 클라우스 서비스들이 많았지만 서울리전이 있다는 점이 마음에 들어 결정했다. 월 20$짜리 요금으로 시작했다.</p><h2>CI/CD : Jenkins <a name="ci-cd-jenkins" class="anchor" href="#ci-cd-jenkins"><span class="header-link"></span></a></h2><p>Github에 푸쉬할 때마다 자동으로 webpack을 실행시키고 nginx를 reload해주는 CI 툴이 필요했다. <a href="https://www.jenkins.io/">Jenkins</a>, <a href="https://www.travis-ci.com/">Travis CI</a>, <a href="https://github.com/features/actions">Github Actions</a> 들 중 고민했었다. Travis CI와 Github Actions는 서버구축이 필요없지만 오픈소스에만 무료이다. Jenkins는 서버만 있다면 마음껏 사용할 수 있다. 바로 위에서 서버를 만들었는데 Jenkins를 쓰지 않을 이유가 없었다. (귀여운 콧수염 아저씨는 덤이다.) <a href="https://issues.jenkins.io/browse/JENKINS-57495?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel">https://issues.jenkins.io/browse/JENKINS-57495?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel</a></p></div></main><footer class="footer"><div class="footer__inner"><a class="footer__link" href="https://github.com/niceandneat"><span class="footer__link-description">@niceandneat</span> <img class="footer__icon" alt="github icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpFNTE3OEEyQTk5QTAxMUUyOUExNUJDMTA0NkE4OTA0RCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpFNTE3OEEyQjk5QTAxMUUyOUExNUJDMTA0NkE4OTA0RCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkU1MTc4QTI4OTlBMDExRTI5QTE1QkMxMDQ2QTg5MDREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkU1MTc4QTI5OTlBMDExRTI5QTE1QkMxMDQ2QTg5MDREIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+m4QGuQAAAyRJREFUeNrEl21ojWEYx895TDPbMNlBK46IUiNmPvHBSUjaqc0H8pF5+aDUKPEBqU2NhRQpX5Rv5jWlDIWlMCv7MMSWsWwmb3tpXub4XXWdPHvc9/Gc41nu+nedc7/8r/99PffLdYdDPsvkwsgkTBwsA/PADJCnzX2gHTwBt8Hl7p537/3whn04XoDZDcpBlk+9P8AFcAghzRkJwPF4zGGw0Y9QS0mAM2AnQj77FqCzrtcwB1Hk81SYojHK4DyGuQ6mhIIrBWB9Xm7ug/6B/nZrBHBegrkFxoVGpnwBMSLR9EcEcC4qb8pP14BWcBcUgewMnF3T34VqhWMFkThLJAalwnENOAKiHpJq1FZgI2AT6HZtuxZwR9GidSHtI30jOrbawxlVX78/AbNfhHlomEUJJI89O2MqeE79T8/nk8nMBm/dK576hZgmA3cp/R4l9/UeSxiHLVIlNm4nFfT0bxyuIj7LHRTKai+zdJobwMKzcZSJb0ePV5PKN+BqAAKE47UlMnERELMM3EdYP/yrd+XYb2mOiYBiQ8OQnoRBlXrl9JZix7D1pHTazu4MoyBcnYamqAjIMTR8G4FT8LuhLsexXYYjICBiqhQBvYb6fLZIJCjPypVvaOoVAW2WcasCnL2Nq82xHJNSqlCeFcDshaPK0twkAhosjZL31QYw+1rlMpWGMArl23SBsZZO58F2tlJXmjOXS+s4WGvpMiBJT/I2PInZ6lIs9/hBsNS1hS6BG0DSqmYEDRlCXQrmy50P1oDRKTSegmNbUsA0zDMwRhPJXeCE3vWLPQMvan6X8AgIa1vcR4AkGZkDR4ejJ1UHpsaVI0g2LInpOsNFUud1rhxSV+fzC9Woz2EZkWQuja7/B+jUrgtIMpy9YCW4n4K41YfzRneW5E1KJTe4B2Zq1Q5EHEtj4U3AfEzR5SVY4l7QYQPJdN2as7RKBF0BPZqqH4VgMAMBL8Byxr7y8zCZiDlnOcEKIPmUpgB5Z2ww5RdOiiRiNajUmWda5IG6WbhsyY2fx6m8gLcoJDJFkH219M3We1+cnda93pfycZpIJEL/s/wSYADmOAwAQgdpBAAAAABJRU5ErkJggg=="></a></div></footer></body></html>